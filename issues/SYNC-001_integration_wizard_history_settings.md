# SYNC-001: 競合/干渉を避ける統合イシュー（ウィザード×履歴×設定×録音/AI処理）

## メタ情報

| 項目 | 内容 |
|:---|:---|
| イシューID | SYNC-001 |
| ステータス | ✅ 完了 |
| 優先度 | P0 🔴 Critical |
| 作成日 | 2025-12-16 |
| 更新日 | 2025-12-16 |
| 完了日 | 2025-12-16 |
| 担当者 | - |
| 関連イシュー | [UX-001](./UX-001_initial_setup_wizard.md), [HIST-001](./HIST-001_transcription_history_store_last_50.md), [UI-001](./UI-001_history_browser_dialog.md) |

---

## 1. 背景・目的

今回追加したい機能は、いずれも初心者体験に直結する一方で、同じ箇所（設定保存、トレイメニュー、録音→AI処理→貼り付け完了）を触るため、無計画に進めると競合や不具合が起きやすい。

この統合イシューは、

- 変更の責務境界を定義し
- 依存関係と実装順を固定し
- 競合しやすい箇所（設定・UI・スレッド・ファイルI/O）でのルールを決めて

**安全に統合**することが目的。

---

## 2. 競合が起きやすいポイント（要注意）

### A. 設定の読み書き

- `.env`（APIキー/プロバイダ/モデル）
- `settings.json`（UI/Audio/Dictionary/Prompts）

ウィザードも Settings 画面も、同じキーを更新する。

### B. メニュー/導線

- 右クリックメニュー（オーバーレイ）
- トレイメニュー

履歴の追加・ウィザード誘導・既存の Settings / Last Result が並ぶため、項目の責務分離と命名が必要。

### C. 録音・スレッド

- 録音中は WAV へストリーミング書き込み
- 停止後に AI スレッドで処理

履歴保存・UI更新・通知が同時に走るため、完了順序を決めないと

- 履歴が二重に入る
- WAV削除タイミングの競合
- UIが古い状態で上書き

が起きる。

### D. ファイルI/O

- `history.json` 追加で I/O が増える
- pyinstaller配布形態だと書き込みディレクトリ権限が問題になりうる

---

## 3. 依存関係（実装順）

1. **HIST-001（履歴永続化のコア）**
   - 保存形式・保存先・atomic write・破損耐性
2. **UI-001（履歴閲覧UI）**
   - 読み込み専用でまず提供
3. **UX-001（初期設定ウィザード）**
   - 設定不足判定と誘導
4. **統合確認**
   - 右クリック/トレイ導線の整理
   - 回帰確認（録音→AI→コピー/貼り付け→履歴反映）

理由: 履歴は他機能の前提になり、UI/ウィザードはその上に乗るため。

---

## 4. 統合ルール（干渉防止）

### 4.1 単一責務（どこで何をするか）

- 設定保存
  - `.env`: 既存の `ensure_env_file_exists()` / `set_key()` を利用
  - `settings.json`: 既存の `save_settings_file()` を利用
- 履歴保存
  - `append_history_item()` を唯一の入口にする
  - `on_ai_finished` / `on_ai_error` からのみ呼ぶ（多重登録防止）
- UI更新
  - オーバーレイ表示: 状態アイコンのみ
  - 結果表示: Last Result / History Dialog

### 4.2 履歴のキーと重複防止

- 履歴 item は `id` を必須（例: `int(time.time()*1000)` など）
- `on_ai_finished` と `on_ai_error` は必ずどちらか一方のみ呼ばれる前提を守る

### 4.3 WAV削除タイミング

- AIWorker の責務として「処理が終わったら wav_path を削除」
- UI側は wav_path を二度と触らない（所有権の明確化）

### 4.4 スレッド境界

- ファイルI/O（履歴保存）を UI スレッドでやる場合でも、処理時間が短い（最大50件）ことを前提
- 重くなる場合のみ、履歴保存を別スレッド/遅延にする（現時点では不要）

### 4.5 セキュリティ

- 履歴/ログ/通知に APIキーを絶対に出さない
- ウィザード入力欄は Password マスク

---

## 5. 統合後のメニュー構成（案）

### オーバーレイ右クリック

- `Setup Wizard...`（設定不足時はラベルを強調してもよい）
- `Settings...`
- `History...`
- `Show Last Result...`
- Provider切替（Gemini/Groq）
- `Quit`

### トレイ

- `Setup Wizard...`
- `Settings...`
- `History...`
- `Show Last Result...`
- Provider切替
- `Show/Hide`
- `Quit`

---

## 6. 回帰確認項目（最低限）

- 録音→停止→AI処理→成功
  - 自動貼り付けON/OFF
  - 履歴に保存される
- AIエラー（APIキーなし/ネットワーク）
  - エラーが履歴（またはLast Result）で確認できる
- ウィザード
  - 設定不足時のみ起動
  - `.env` / `settings.json` が保存される
- 履歴UI
  - 50件表示
  - Copyができる

---

## 7. 実装完了項目

- [x] HIST-001 実装
- [x] UI-001 実装
- [x] UX-001 実装
- [x] メニュー統合（右クリック/トレイに Setup Wizard / History / Last Result）
- [x] 回帰確認（録音→AI→履歴保存→コピー導線、設定不足時のウィザード起動）
