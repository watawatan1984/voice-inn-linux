# BUG-002: デバイステスト（マイクテスト）実行時にエラーになる

## メタ情報

| 項目 | 内容 |
|:---|:---|
| イシューID | BUG-002 |
| ステータス | ⏳ 対応待ち |
| 優先度 | P2 🟡 Medium |
| 作成日 | 2025-12-17 |
| 更新日 | 2025-12-17 |
| 担当者 | - |
| 関連イシュー | [BUG-003](./BUG-003_multiple_recordings_error_gain.md) |

---

## 1. 背景・目的

設定画面の「デバイステスト（マイクテスト）」が失敗すると、入力デバイスの切り分けができず、初期導入・トラブルシュートが困難になる。

本イシューでは、デバイステストが **エラーにならず**、失敗時も **ユーザーが理解できる情報（原因/対処）** を得られる状態にする。

---

## 2. 現状の問題点

- デバイステスト実行時にエラーが発生する
- 失敗理由（PortAudio系エラー、デバイス未接続、サンプルレート不一致等）がUI上で分かりにくい可能性がある

---

## 3. 実装方針

- テスト用の録音/再生（または録音のみ）処理を **例外耐性** のある形にし、失敗時に例外内容を `app.log` に残す
- 失敗原因に応じて
  - デバイス選択の見直し
  - サンプルレート/チャンネル/ dtype の調整
  - 入力権限/占有（他アプリ）
  - PulseAudio/PipeWire/ALSA
  を案内できるようにする
- テスト後はストリーム/スレッドを必ずクリーンアップし、通常録音に影響を残さない

---

## 4. 具体的な要件

### A. アプリ本体（Python）

| 対象ファイル | 変更内容 |
|:---|:---|
| `main.py` | デバイステストの例外捕捉とログ強化（例外種別・メッセージ・デバイス情報） |
| `main.py` | テスト終了時のクリーンアップ（スレッド/ストリーム/タイマー）を保証 |

### B. UI（PyQt6）

| 対象UI/画面 | 変更内容 |
|:---|:---|
| `SettingsDialog` | 失敗時に、ユーザーが次に取るべき行動が分かる表示（例: デバイス変更、再試行、ログの場所） |

---

## 5. 挙動シナリオ（ユースケース）

| シチュエーション | 期待する挙動 |
|:---|:---|
| 正常系: デバイステスト実行 | テストが成功し、音声入力が可能なことを確認できる |
| 異常系: デバイスが無効/未接続 | 落ちずに失敗し、原因と対処が表示される |
| 異常系: 他アプリがデバイス占有 | 落ちずに失敗し、占有の可能性と対処が表示される |

---

## 6. テストケース

| ID | シナリオ | 手順 | 期待結果 |
|:---|:---|:---|:---|
| TC-01 | 正常に成功 | 1. 設定を開く 2. デバイステスト実行 | 成功メッセージが出る |
| TC-02 | 失敗時の案内 | 1. 無効なデバイスを選択 2. デバイステスト実行 | 例外で落ちず、対処が表示される |
| TC-03 | 後続録音への影響なし | 1. デバイステスト実行 2. その後に通常録音 | 通常録音が成功する |

---

## 7. 影響範囲

| 領域 | 影響内容 | 対策 |
|:---|:---|:---|
| 録音/AI処理 | テスト用ストリームが残ると通常録音に影響 | テスト終了時に確実にクリーンアップ |
| ログ | 例外内容の出力が増える | 機密情報（APIキー）は出さない |

---

## 8. 懸念点・確認事項

- [ ] エラー発生時のUI表示に、ログパス（`~/.local/state/voice-in/app.log`）が含まれているか
- [ ] デバイステストで使用するデバイス/サンプルレートが「通常録音」と一致しているか
- [ ] Wayland環境での動作差分の扱い（本件は主にLinux/X11想定）

---

## 9. 実装完了項目

### アプリ本体
- [ ] デバイステスト失敗時の例外捕捉
- [ ] 失敗時ログの強化（デバイス情報/設定値）
- [ ] テスト終了時の確実なクリーンアップ

### UI
- [ ] 失敗時の対処案内

### テスト
- [ ] TC-01 確認完了
- [ ] TC-02 確認完了
- [ ] TC-03 確認完了

---

## 10. 補足・参考資料

- ログ: `~/.local/state/voice-in/app.log`
- クラッシュログ: `~/.local/state/voice-in/crash.log`

---

## 変更履歴

| 日付 | 変更者 | 内容 |
|:---|:---|:---|
| 2025-12-17 | - | 初版作成 |
