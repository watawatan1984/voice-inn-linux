# HIST-001: 文字起こし履歴を過去50件保持（ログ以外の永続化）

## メタ情報

| 項目 | 内容 |
|:---|:---|
| イシューID | HIST-001 |
| ステータス | ✅ 完了 |
| 優先度 | P1 🟠 High |
| 作成日 | 2025-12-16 |
| 更新日 | 2025-12-16 |
| 完了日 | 2025-12-16 |
| 担当者 | - |
| 関連イシュー | [UI-001](./UI-001_history_browser_dialog.md), [SYNC-001](./SYNC-001_integration_wizard_history_settings.md) |

---

## 1. 背景・目的

初心者ユーザーは「貼り付けに失敗した」「どこに結果が行ったか分からない」といった体験で離脱しやすい。
ログ（`app.log`）は初心者には読めないため、**アプリ内で閲覧・コピーできる履歴**が必要。

要件は「過去50件を保持し、呼び出してコピペできる」。

---

## 2. 現状の問題点

- 現状は「最後の結果」だけで、過去の結果は辿れない
- 自動貼り付け失敗時に再取得が難しい

---

## 3. 実装方針

- `history.json` をXDG準拠の状態ディレクトリ（`~/.local/state/voice-in/`）配下に保存
- 履歴は最大50件でリングバッファ/末尾切り詰め
- 書き込みは原則メインスレッドで行い、競合を避ける
- 保存は **原子的（テンポラリファイル→リネーム）** に行い、破損時は安全に復旧

---

## 4. 具体的な要件

### A. 保存対象

- 成功時
  - `text`（最終出力）
  - `provider`（gemini/groq）
  - `created_at`（ISO8601）
- 失敗時（任意だが推奨）
  - `error`（ユーザーに見せても理解可能な文言）
  - `created_at`

### B. 保存しない情報

- APIキー
- 音声ファイル実体（WAV）

### C. ファイル形式（案）

```json
{
  "version": 1,
  "items": [
    {
      "id": "uuid-or-timestamp",
      "created_at": "2025-12-16T17:00:00+09:00",
      "provider": "gemini",
      "text": "...",
      "error": null
    }
  ]
}
```

### D. API（内部関数）案

- `load_history_file()`
- `append_history_item(text=None, error=None, provider=None)`
- `save_history_file(items)`（atomic write）

---

## 5. 挙動シナリオ（ユースケース）

| シチュエーション | 期待する挙動 |
|:---|:---|
| 文字起こし成功 | 履歴の先頭（または末尾）に追加される |
| 文字起こし失敗 | エラー履歴が残り、理由を確認できる（任意） |
| 50件を超える | 古い履歴から削除される |
| 履歴ファイルが壊れている | アプリが落ちず、空履歴で起動できる |

---

## 6. テストケース

| ID | シナリオ | 手順 | 期待結果 |
|:---|:---|:---|:---|
| TC-01 | 追加 | 成功結果を2件保存 | 2件が読み出せる |
| TC-02 | 切り詰め | 60件追加 | 50件だけ残る |
| TC-03 | 破損耐性 | 壊れたJSONを置く | 落ちずに起動、履歴は空扱い |
| TC-04 | 原子書き込み | 書き込み途中に異常終了（疑似） | 次回起動でJSON破損が起きにくい |

---

## 7. 影響範囲

| 領域 | 影響内容 | 対策 |
|:---|:---|:---|
| ファイルI/O | 文字起こしごとにJSON更新 | 50件のみ、atomic write、必要なら遅延保存 |
| UI導線 | UI-001で閲覧導線追加 | 既存の「Last Result」も維持 |

---

## 8. 懸念点・確認事項

- [ ] 個人情報が混じる可能性（ユーザーへ注意喚起の要否）

---

## 9. 実装完了項目

- [x] `history.json` の読み書き
- [x] 50件制限
- [x] 破損耐性
- [x] 成功/失敗の記録（成功: text / 失敗: error）
