# BUG-003: 複数回の録音でエラーになる（ゲイン+10dB含む）

## メタ情報

| 項目 | 内容 |
|:---|:---|
| イシューID | BUG-003 |
| ステータス | ⏳ 対応待ち |
| 優先度 | P1 🟠 High |
| 作成日 | 2025-12-17 |
| 更新日 | 2025-12-17 |
| 担当者 | - |
| 関連イシュー | [BUG-002](./BUG-002_device_test_microphone_error.md) |

---

## 1. 背景・目的

音声入力アプリとして「複数回連続で録音→文字起こし」が安定して動作しないと、実用が難しい。

特にゲイン（+10dB）を有効にしている状況でエラーが出る場合、録音の後処理（増幅/正規化/型変換/ストリーム解放）に問題がある可能性がある。

本イシューでは、連続利用（複数回）でもエラーにならないことを目的とする。

---

## 2. 現状の問題点

- 1回目は成功するが、2回目以降の録音でエラーが発生することがある
- ゲイン+10dBの有無が影響している可能性がある
- 失敗時にどの段階（録音開始/停止、ファイル保存、AI処理、貼り付け）で失敗したかが分かりにくい可能性がある

---

## 3. 実装方針

- 連続録音で再利用されるリソースの洗い出し
  - オーディオ入力ストリーム
  - 録音スレッド/ワーカ
  - 一時ファイル（wav）
  - キュー/バッファ
- 録音終了時（成功/失敗どちらでも）の確実なクリーンアップ
- ゲイン処理（+10dB）の適用順序と型（float32/int16等）を整理し、クリッピングや例外を避ける
- 失敗時ログを強化し、どの段階で落ちたかを追えるようにする

---

## 4. 具体的な要件

### A. アプリ本体（Python）

| 対象ファイル | 変更内容 |
|:---|:---|
| `main.py` | 連続録音時の例外捕捉と、スレッド/ストリームの再初期化手順の統一 |
| `main.py` | ゲイン処理の安全化（dtypeの統一、クリップ、NaN/inf対策） |
| `main.py` | エラー時に段階情報を含めてログ出力（record/start/stop/save/process/paste 等） |

---

## 5. 挙動シナリオ（ユースケース）

| シチュエーション | 期待する挙動 |
|:---|:---|
| 正常系: 連続で3回録音 | 3回とも成功し、貼り付けまで完了する |
| 異常系: 途中で録音停止を連打 | 落ちずに録音が終了し、次の録音が可能 |
| 異常系: ゲイン+10dBでクリップしやすい入力 | 落ちずに処理され、必要なら音割れはするがアプリは継続 |

---

## 6. テストケース

| ID | シナリオ | 手順 | 期待結果 |
|:---|:---|:---|:---|
| TC-01 | 連続録音（ゲインなし） | 1. 3回連続で録音→停止 | すべて成功 |
| TC-02 | 連続録音（ゲイン+10dB） | 1. ゲイン+10dB 2. 3回連続で録音→停止 | すべて成功 |
| TC-03 | 録音中断 | 1. 録音開始 2. すぐ停止 3. 再度録音 | エラーなく再録音できる |

---

## 7. 影響範囲

| 領域 | 影響内容 | 対策 |
|:---|:---|:---|
| 録音/AI処理 | クリーンアップや初期化順序変更 | 回帰テスト（通常の成功フロー） |
| ログ | 段階ログ追加で出力増 | ログの分かりやすさを優先（機密は出さない） |

---

## 8. 懸念点・確認事項

- [ ] 実際に出ているエラーメッセージ（スタックトレース/PortAudioコード）を `app.log` から取得できているか
- [ ] 録音スレッド/ワーカの stop/cleanup が複数回呼ばれても安全か
- [ ] wav保存や前処理で古いファイルハンドルが残っていないか

---

## 9. 実装完了項目

### アプリ本体
- [ ] 連続録音での例外原因を特定
- [ ] クリーンアップ/再初期化の修正
- [ ] ゲイン処理の安全化
- [ ] 段階ログ追加

### テスト
- [ ] TC-01 確認完了
- [ ] TC-02 確認完了
- [ ] TC-03 確認完了

---

## 10. 補足・参考資料

- ログ: `~/.local/state/voice-in/app.log`
- クラッシュログ: `~/.local/state/voice-in/crash.log`

---

## 変更履歴

| 日付 | 変更者 | 内容 |
|:---|:---|:---|
| 2025-12-17 | - | 初版作成 |
