# UX-001: 初心者が迷わない初期設定ウィザード（APIキー未設定時の案内、入力デバイス自動選択）

## メタ情報

| 項目 | 内容 |
|:---|:---|
| イシューID | UX-001 |
| ステータス | ✅ 完了 |
| 優先度 | P1 🟠 High |
| 作成日 | 2025-12-16 |
| 更新日 | 2025-12-16 |
| 完了日 | 2025-12-16 |
| 担当者 | - |
| 関連イシュー | [SYNC-001](./SYNC-001_integration_wizard_history_settings.md), [HIST-001](./HIST-001_transcription_history_store_last_50.md) |

---

## 1. 背景・目的

voice-in は「常駐アイコン＋ホールドキーで録音」という特性上、初心者が最初に詰まりやすいポイントが集中している。

- APIキー未設定で起動しても、どこを直せばよいか分からない
- 入力デバイスが複数ある環境で、正しいマイクを選べない
- ホールドキーの意味や、貼り付けの挙動が分からない

目的は、**初回起動から最初の文字起こし成功までを、迷いなく到達できる導線**にすること。

---

## 2. 現状の問題点

- `.env` の設定が不足していると、実行時エラーになりやすい
- Settings 画面はあるが、初心者が「どれから設定すべきか」を理解しにくい
- 入力デバイスが意図せず Default になり、マイクが入らないケースがある

---

## 3. 実装方針（計画）

- **初回起動または設定不足時にウィザードを自動起動**
- ウィザードは「最短で成功」するように、必要項目のみを段階的に聞く
- 設定保存は既存の `.env` / `settings.json` の仕組みを再利用し、互換性を維持

ウィザード実装は PyQt6 の `QWizard` または `QDialog + QStackedWidget` を想定。

---

## 4. 具体的な要件

### A. 起動条件

- 1) 初回起動
  - `settings.json` が存在しない、または `app_settings` がデフォルト状態に近い場合
- 2) 設定不足
  - `AI_PROVIDER=gemini` で `GEMINI_API_KEY` が空
  - `AI_PROVIDER=groq` で `GROQ_API_KEY` が空
  - `sounddevice` の入力デバイスが見つからない/利用不可

### B. ウィザードのページ構成（案）

1. **Welcome**
   - 「このアプリはホールドキーで録音して文字起こしします」
   - Wayland制限（貼り付けやグローバルキー）が出る可能性を簡潔に表示
2. **AI Provider / API Key**
   - provider選択（Gemini / Groq）
   - 該当キーの入力
   - バリデーション: 空文字を禁止
   - 保存: `.env`（既存の `set_key` を利用）
3. **Input Device 自動選択 + テスト**
   - 自動選択ロジック（後述）
   - 候補表示（プルダウン）＋「音量メーター」テスト（既存 `Mic Test` を再利用/流用）
4. **操作（ホールドキー/自動貼り付け）**
   - hold key（alt/ctrl 左右）
   - auto paste ON/OFF
   - paste delay
5. **Finish**
   - 「設定完了。試しに録音してみてください」
   - 「履歴」導線（HIST-001/UI-001が入った後に案内強化）

### C. 入力デバイス自動選択ロジック（案）

- `sd.query_devices()` から `max_input_channels > 0` のデバイスを抽出
- `sd.default.device` の input 側が有効ならそれを優先
- それが無効なら、候補の先頭を仮選択し、マイクテストでユーザーが確認

### D. 保存先

- APIキー: `.env`
- それ以外: `settings.json`（audio/ui/dictionary/prompts）

---

## 5. 挙動シナリオ（ユースケース）

| シチュエーション | 期待する挙動 |
|:---|:---|
| 初回起動 | ウィザードが自動的に開く |
| APIキー未設定で録音しようとする | ウィザード or 設定画面へ誘導し、何が足りないか明確に表示 |
| マイクが複数ある | 自動選択された候補を提示し、メーターで確認できる |
| 設定完了 | すぐに録音→文字起こしが成功する |

---

## 6. テストケース

| ID | シナリオ | 手順 | 期待結果 |
|:---|:---|:---|:---|
| TC-01 | 初回起動 | 設定ファイルがない状態で起動 | ウィザード起動、完了後に設定が保存される |
| TC-02 | Geminiキー未設定 | `AI_PROVIDER=gemini` & `GEMINI_API_KEY`空 | ウィザードでキー入力を促される |
| TC-03 | 入力デバイス自動選択 | マイク複数の環境 | 候補が表示され、テストで確認できる |
| TC-04 | 設定保存 | ウィザード完了 | `.env` と `settings.json` の内容が反映される |

---

## 7. 影響範囲

| 領域 | 影響内容 | 対策 |
|:---|:---|:---|
| 設定保存 | `.env`/`settings.json` の更新頻度が増える | 既存互換を維持し、保存失敗時のメッセージを明確化 |
| 起動導線 | 起動時にウィザードが出る | 設定済みユーザーには出さない |

---

## 8. 懸念点・確認事項

- [x] Wayland環境でのグローバルキー/貼り付け制限が出る場合の案内文
- [x] APIキーの取り扱い（画面上のマスキング、ログ/履歴に残さない）

---

## 9. 実装完了項目

- [x] 設定不足判定（起動時）
- [x] ウィザードUI
- [x] 入力デバイス自動選択
- [x] 保存と反映
- [x] 回帰確認（録音→文字起こし→貼り付け）

---

## 10. 補足

既存の Settings 画面は残し、ウィザードは「最短で成功する導線」として位置付ける。
