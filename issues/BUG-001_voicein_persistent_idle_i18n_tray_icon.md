# BUG-001: 音声入力後にアプリが終了する問題の修正（常駐維持・トレイ状態色・設定画面の多言語化）

## メタ情報

| 項目 | 内容 |
|:---|:---|
| イシューID | BUG-001 |
| ステータス | ✅ 完了 |
| 優先度 | P1 🟠 High |
| 作成日 | 2025-12-16 |
| 更新日 | 2025-12-16 |
| 完了日 | 2025-12-16 |
| 担当者 | - |
| 関連イシュー | [SYNC-001](./SYNC-001_integration_wizard_history_settings.md), [UX-001](./UX-001_initial_setup_wizard.md), [UI-001](./UI-001_history_browser_dialog.md), [HIST-001](./HIST-001_transcription_history_store_last_50.md) |

---

## 1. 背景・目的

`/dist` の exe から起動した際、音声入力（録音→AI処理→貼り付け）後にアプリが終了してしまうことがある。

本イシューでは以下を満たすことを目的とする。

- 音声入力後にアプリが落ちない（クラッシュ原因を潰す/原因が残る場合はログで追跡可能にする）
- ユーザーが終了操作を行うまで常駐（待機）を維持する
- 待機/録音/処理中でトレイアイコンの状態（色）が分かる
- 設定画面の表示言語を切り替え可能にし、日本語をデフォルトにする

---

## 2. 現状の問題点

- 音声入力完了後にプロセスが終了する（ユーザー視点では「クラッシュ」か「仕様」か判別できない）
- 待機中も録音中と見た目が近く、状態が分かりづらい
- 設定画面が英語中心で、非英語ユーザーが設定変更しづらい

---

## 3. 実装方針

- **クラッシュ要因の除去**
  - 実行時に例外が発生しても原因追跡できるよう、例外ログを残す
- **常駐維持**
  - `QApplication` のイベントループを継続し、最後のウィンドウが閉じても終了しないようにする
- **状態アイコン**
  - トレイアイコンを状態に応じて生成できるようにし、`idle/recording/processing/error/success` を切り替える
- **i18n（簡易辞書方式）**
  - 翻訳辞書 `_TRANSLATIONS` と `t()` を追加し、UI文言を差し替える
  - 表示言語は `settings.json` の `ui.language` に保存し、デフォルトを `ja` とする

---

## 4. 具体的な要件

### A. アプリ本体（Python）

| 対象ファイル | 変更内容 |
|:---|:---|
| `main.py` | 例外ログ（`crash.log`）の導入（`faulthandler` / `sys.excepthook`） |
| `main.py` | 音声入力後に落ちる原因となる実装上の問題を修正 |

### B. UI（PyQt6）

| 対象UI/画面 | 変更内容 |
|:---|:---|
| トレイアイコン | 待機=緑、録音=赤、処理中=黄、エラー=濃赤、成功=緑 |
| `SettingsDialog` | 表示言語（日本語/英語/フランス語/スペイン語/韓国語）切替を追加 |
| 履歴/直近結果/トレイメニュー | `t()` による文言切替に対応 |

### C. データ/永続化

| 対象 | 変更内容 |
|:---|:---|
| `settings.json` | `ui.language` を追加（デフォルト `ja`） |
| `~/.local/state/voice-in/crash.log` | 異常終了時の原因追跡用ログ |

---

## 5. 挙動シナリオ（ユースケース）

| シチュエーション | 期待する挙動 |
|:---|:---|
| 待機中 | トレイアイコンが緑、アプリは常駐し続ける |
| 録音中 | トレイアイコンが赤になる |
| 録音停止〜AI処理中 | トレイアイコンが黄になる |
| 成功 | トレイアイコンが緑に戻り、必要に応じて貼り付けが行われる |
| 失敗 | トレイアイコンが濃赤になり、通知/履歴からエラー確認ができる |
| 言語変更 | 設定保存後、主要UI文言が選択言語で表示される |

---

## 6. テストケース

| ID | シナリオ | 手順 | 期待結果 |
|:---|:---|:---|:---|
| TC-01 | 音声入力後も常駐 | 1. exe起動 2. 録音→停止 3. 処理完了を待つ | アプリが終了しない |
| TC-02 | トレイ色の遷移 | 1. 待機 2. 録音開始 3. 録音停止 4. 結果待ち | 緑→赤→黄→緑（またはエラー時は濃赤） |
| TC-03 | 言語切替の保存 | 1. 設定で言語変更 2. 保存 3. 再起動 | `settings.json` の `ui.language` が維持される |
| TC-04 | クラッシュログ | 例外が起きる状況を再現（可能なら） | `crash.log` に原因が残る |

---

## 7. 影響範囲

| 領域 | 影響内容 | 対策 |
|:---|:---|:---|
| UI文言 | `t()` 導入により文言が差し替わる | 主要導線（トレイ/設定/履歴/直近結果）の表示確認 |
| 設定 | `ui.language` キーが追加 | 既存ユーザーはデフォルト `ja` で問題なく動作 |
| トレイ表示 | 状態に応じたアイコン色 | 状態遷移の回帰確認 |

---

## 8. 懸念点・確認事項

- [ ] すべてのUI文言が完全に翻訳されているか（未対応ラベルが残る可能性）
- [ ] `/dist` exe 環境での例外が `crash.log` に確実に記録されるか

---

## 9. 実装完了項目

### アプリ本体
- [x] 例外ログの導入（`crash.log`）
- [x] 音声入力後に終了する原因の修正

### UI
- [x] トレイアイコンの状態色
- [x] 設定画面に表示言語切替を追加
- [x] 主要UI文言の多言語化

### テスト
- [x] `python3 -m py_compile main.py` で構文チェック

---

## 変更履歴

| 日付 | 変更者 | 内容 |
|:---|:---|:---|
| 2025-12-16 | - | 初版作成 |
