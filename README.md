# Voice In（ミニマムな音声入力アプリ）

Linux環境で動作する、ミニマムな音声入力アプリです。
`Left Alt` キーを押している間の音声を認識し、AI（Groq Whisper + Llama 3 / Gemini）で文字起こし・整形して、現在アクティブなウィンドウに入力します。

## 特徴
- **高精度な文字起こし**: Whisper Large v3 モデルを使用。
- **文字起こし後の追加修正（プロンプト）**: 文字起こし結果をそのまま貼り付けるだけでなく、整形用プロンプトにより文体/表現を調整できます（設定画面から編集可能）。
- **AIによる自動整形**: フィラー（えー、あのー）の除去、句読点の付与、適切なフォーマットへの変換。
- **辞書機能**: よく使う専門用語や誤認識しやすい単語を自動で置換します。
- **邪魔にならないUI**: 画面右下に小さなアイコンとして常駐します。

## 仕組み（なぜ軽いのか）

文字起こし/整形は外部API（Groq / Gemini）を利用するため、ローカルPCに大きな計算負荷をかけずにサクサク動作します。
一方で、**結果が返ってくるまで多少のラグ**が発生する場合があります（ネットワーク状況・API混雑状況に依存）。

## 動作環境
- OS: Linux (Ubuntu/Debian系推奨)
- Python: 3.8以上
- GUI: X11推奨 (Waylandでは一部機能に制限がある場合があります)

## セットアップ手順

### 1. システムパッケージのインストール
必要なライブラリをインストールします。
```bash
sudo apt update
sudo apt install -y python3-pip python3-venv libportaudio2 libxcb-cursor0 libxcb-xinerama0
```

### 2. プロジェクトのセットアップ
```bash
# プロジェクトディレクトリへ移動
cd /path/to/voice-in

# 仮想環境の作成
python3 -m venv .venv

# Pythonライブラリのインストール
.venv/bin/pip install -r requirements.txt
```

### 3. APIキーの設定
プロジェクトの親ディレクトリまたは同階層に `.env` ファイルを作成し、Groq APIキーを設定します。
Groq APIキーは https://console.groq.com/keys から取得できます。
```bash
GROQ_API_KEY=gsk_xxxxxxxxxxxxxxxxxxxxxxxx
```

## 使い方

1. **起動**:
   ```bash
   .venv/bin/python main.py
   ```
   画面右下に正方形のアイコン（🎤）が表示されます。

2. **音声入力**:
   - 入力したいテキストボックス（エディタ、ブラウザなど）をクリックしてフォーカスします。
   - **`Left Alt` (左アルト) キーを押し続けます**。
   - アイコンが赤色（🎙️）になり、録音が始まります。マイクに向かって話してください。
   - 話し終わったらキーを離します。

3. **処理と入力**:
   - アイコンが黄色（⏳）になり、「Thinking...」状態になります。
   - 処理が完了すると、自動的にテキストが貼り付けられ、アイコンが一瞬チェックマーク（✅）になります。

## カスタマイズ

### ログの見方（Raw Whisper / Refined Llama）
ターミナルにはデバッグ用ログとして、以下が出力されます。

- **Raw Whisper**: Whisper の文字起こし生テキスト
- **Refined Llama**: 2段目（整形AI）で整形された最終テキスト

もし **Refined 側だけ**が英語化したり内容を言い換えたりする場合は、整形プロンプト（`groq_refine_system_prompt`）が原因です。

### どのプロンプトを調整すべきか
Prompts タブには、概ね次の役割があります。

- **Groq Whisper Prompt**（`groq_whisper_prompt`）
  - 1段目の文字起こしの方向性を軽く誘導します。
  - 基本は「これは音声入力の文字起こし」程度の短い指示で十分です。

- **Groq Refine System Prompt**（`groq_refine_system_prompt`）
  - 2段目の整形AIの振る舞いを決めます。
  - ここが強すぎると、固有名詞の推測変換や英語化、説明文の生成（“解説”）が起きやすくなります。

### 調整ガイド（おすすめ）
固有名詞の勝手な変換や説明文が出る場合は、まず `groq_refine_system_prompt` を次の方針に寄せてください。

- **日本語維持**（英語化・ローマ字化禁止）
- **固有名詞を推測で置換しない**（例: 「ジョン・カビラ」→英語表記にしない）
- **内容を改変しない**（創作・補完・要約・解説をしない）
- **フィラー除去＋句読点付与＋改行整理**程度に限定

### 辞書登録
`main.py` 内の `DICTIONARY` 変数を編集することで、単語の置換ルールを追加できます。

```python
    # 辞書定義 (ユーザー定義の置換ルール)
    DICTIONARY = {
        "秋道中": "待機中",
        "詐称化": "最小化",
        # "誤認識される単語": "正しい単語", の形式で追加
    }
```

## トラブルシューティング
- **起動しない**: `.env` ファイルに正しいAPIキーがあるか確認してください。
- **反応しない**: `Left Alt` キーが正しく認識されていない可能性があります。ターミナルのログを確認してください。
- **貼り付けられない**: 一部のアプリではクリップボード貼り付けがブロックされることがあります。その場合は手動で `Ctrl+V` を押してください。

### 無音対策（無音時に勝手な文章が出る）
- 無音（例: `Left Alt` を押したが話さなかった）でも、音声認識/整形AIが「それっぽい文章」を推測生成してしまうことがあります。
- 対策として、アプリ側で **無音を検知した場合はAI処理を行わず**、貼り付けもスキップします（通知: `No speech detected (silence).`）。

### 話しているのに検出されない・されにくい場合（使いこなし）
- **入力ゲインを上げる**: Settings の `Input Gain (dB)` を少しずつ上げてください。
  - 例: `+0dB` → `+6dB` → `+10dB`
  - 上げすぎるとクリップ（音割れ）し、逆に認識精度が落ちる場合があります。
- **マイクとの距離/向き**: 口元から10〜20cm程度、マイクに正対するように調整すると安定します。
- **環境音を下げる**: キーボード打鍵音やファン音が強いと、無音判定や認識に影響する場合があります。
- **短すぎる入力は避ける**: すぐに `Left Alt` を離すと「短すぎる=無音扱い」になる場合があります。

### Q&A
- **Q: 話しているのに `No speech detected (silence).` になる**
  - A: 入力レベルが小さい/距離が遠い可能性があります。`Input Gain (dB)` を上げ、マイクに近づいて再試行してください。
- **Q: ゲインを上げたら音割れする**
  - A: ゲインを下げてください（例: `+10dB` → `+6dB`）。マイク自体の入力感度（OS側）を下げるのも有効です。
- **Q: 無音なのに文字が出てしまう**
  - A: 無音対策（無音検知）により、通常はAI処理がスキップされます。まだ出る場合は、ログを確認してください。

### 自動貼り付け（Auto Paste）について
- 自動貼り付けは「クリップボードへコピー」した後に、`Ctrl+V` を疑似入力します。
- X11 環境では `xdotool` が利用できる場合、録音開始時点のアクティブウィンドウへ貼り付けることで安定性を上げています。
- Wayland 環境では、アプリから他アプリへのキー送信が制限されることがあり、自動貼り付けが不安定になる場合があります。

### Windows / macOS で使えますか？
基本的な構成（PyQt6 / sounddevice / Groq / Gemini）はクロスプラットフォームですが、現状このリポジトリは **Linux（X11）を主対象**として調整されています。

- **Windows**
  - Python からの実行自体は可能な構成です。
  - 音声入力（PortAudio）やグローバルキー、貼り付け挙動は環境依存のため、調整が必要になる場合があります。
  - 配布（PyInstaller）は Windows 上でビルドする必要があります。

- **macOS**
  - Python からの実行自体は可能な構成です。
  - グローバルキー/他アプリへの入力は macOS のセキュリティ制約があり、アクセシビリティ権限が必要になる場合があります。
  - 配布（PyInstaller）は macOS 上でビルドする必要があります（コード署名/公証が必要になる場合があります）。
